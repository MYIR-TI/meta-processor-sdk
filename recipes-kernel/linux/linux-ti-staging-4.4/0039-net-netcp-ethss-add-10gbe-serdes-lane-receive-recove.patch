From a1f1d01304df47a44e4884a013fa4ccf34cbf6e0 Mon Sep 17 00:00:00 2001
From: WingMan Kwok <w-kwok2@ti.com>
Date: Fri, 26 Aug 2016 09:28:14 -0400
Subject: [PATCH 39/65] net: netcp: ethss: add 10gbe serdes lane receive
 recovery

When the remote device that the 10gbe device is connected
to is restarted for whatever reason, the receive direction
of a 10gbe serdes lane will need to be reset in order to
sync up again with the remote device's transmit pattern.

This patch adds support of such a 10gbe serdes lane receive
recovery.  When 10gbe driver detects a serdes lane down, it
will start a periodic attempt to recover the receive direction
of that lane.

This patch also adopts the remodelling of one SerDes lane
as a separate PHY device. Hene phy_init() is invoked per
each ethernet interface.

The changes are needed because of the recent update to the
SerDes configuration.

Signed-off-by: WingMan Kwok <w-kwok2@ti.com>
[j-stiffler@ti.com: rebased against recent changes]
Signed-off-by: Jacob Stiffler <j-stiffler@ti.com>
---
 Documentation/devicetree/bindings/net/keystone-netcp.txt |  4 ----
 drivers/net/ethernet/ti/netcp_ethss.c                    | 15 ---------------
 2 files changed, 19 deletions(-)

diff --git a/Documentation/devicetree/bindings/net/keystone-netcp.txt b/Documentation/devicetree/bindings/net/keystone-netcp.txt
index c8e8ff3..fffbe7d 100644
--- a/Documentation/devicetree/bindings/net/keystone-netcp.txt
+++ b/Documentation/devicetree/bindings/net/keystone-netcp.txt
@@ -124,10 +124,6 @@ Optional properties:
 				will only initialize these ports and attach PHY
 				driver to them if needed.
 
-- phys:		phandles to serdes devices
-		see Documentation/devicetree/bindings/phy/ti-phy.txt
-		for Keystone SerDes device specificcations.
-
 - cpts:		sub-node containing properties related to cpts configurations.
 		Optional properties:
 		- rftclk_sel:
diff --git a/drivers/net/ethernet/ti/netcp_ethss.c b/drivers/net/ethernet/ti/netcp_ethss.c
index 20ee404..a3e43db 100644
--- a/drivers/net/ethernet/ti/netcp_ethss.c
+++ b/drivers/net/ethernet/ti/netcp_ethss.c
@@ -3621,21 +3621,6 @@ static int gbe_probe(struct netcp_device *netcp_device, struct device *dev,
 	if (ret)
 		return ret;
 
-	for (i = 0; i < gbe_dev->num_serdeses; i++) {
-		phy = devm_of_phy_get_by_index(dev, node, i);
-		if (IS_ERR(phy)) {
-			/* this one may be disabled, quietly skip */
-			dev_dbg(dev, "No %s serdes driver found: %ld\n",
-				node->name, PTR_ERR(phy));
-			continue;
-		}
-
-		gbe_dev->serdes_phy[i] = phy;
-		ret = phy_init(phy);
-		if (ret < 0)
-			goto exit_phys;
-	}
-
 	cpts_np = of_get_child_by_name(node, "cpts");
 	if (cpts_np && of_device_is_available(cpts_np))
 		ret = gbe_of_parse_cpts(gbe_dev, cpts_np);
-- 
1.9.1

