From 7c36899ae03ac969cc66017c306df256c7df3cfa Mon Sep 17 00:00:00 2001
From: Nikhil Devshatwar <nikhil.nd@ti.com>
Date: Thu, 24 Sep 2015 00:47:42 +0530
Subject: [PATCH 6/9] HACK: Remove the V4L2 check and fix the DMA address

Signed-off-by: Nikhil Devshatwar <nikhil.nd@ti.com>
---
 drivers/media/platform/ti-vpe/vpe.c      | 2 ++
 drivers/media/v4l2-core/videobuf2-core.c | 5 +++--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/media/platform/ti-vpe/vpe.c b/drivers/media/platform/ti-vpe/vpe.c
index 7493622..f2e5103 100644
--- a/drivers/media/platform/ti-vpe/vpe.c
+++ b/drivers/media/platform/ti-vpe/vpe.c
@@ -1063,6 +1063,8 @@ static void add_out_dtd(struct vpe_ctx *ctx, int port)
 				port);
 			return;
 		}
+		if (plane)
+			dma_addr += q_data->width * q_data->height;
 	}
 
 	if (q_data->flags & Q_DATA_FRAME_1D)
diff --git a/drivers/media/v4l2-core/videobuf2-core.c b/drivers/media/v4l2-core/videobuf2-core.c
index cf9d644..119fcd9 100644
--- a/drivers/media/v4l2-core/videobuf2-core.c
+++ b/drivers/media/v4l2-core/videobuf2-core.c
@@ -586,8 +586,9 @@ static int __verify_length(struct vb2_buffer *vb, const struct v4l2_buffer *b)
 
 	if (V4L2_TYPE_IS_MULTIPLANAR(b->type)) {
 		for (plane = 0; plane < vb->num_planes; ++plane) {
-			length = (b->memory == V4L2_MEMORY_USERPTR ||
-				  b->memory == V4L2_MEMORY_DMABUF)
+			if (b->memory == V4L2_MEMORY_DMABUF)
+				continue;
+			length = (b->memory == V4L2_MEMORY_USERPTR)
 			       ? b->m.planes[plane].length
 			       : vb->v4l2_planes[plane].length;
 			bytesused = b->m.planes[plane].bytesused
-- 
1.9.1

